# 趣谈网络协议

## 开篇词

### 开篇词 | 想成为技术牛人？先搞定网络协议！

> 第一，我会从身边经常见到的事情出发，用故事来讲解各种网络协议，然后慢慢扩展到不熟悉的领域。
> 
> 第二，我会用贴近场景的方式来讲解网络协议，将各个层次的关系串起来，而非孤立地讲解某个概念。
> 
> 第三，我会在讲解完各个层次的网络协议之后，着重剖析如何在当下热门领域使用这些协议，比如云计算、容器和微服务。

## 第一模块 通信协议综述 (4讲)

#### 第1讲 | 为什么要学习网络协议？

> 只有通过这种协议，计算机才知道我们想让它做什么。

协议三要素

- 语法，就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。

- 语义，就是这一段内容要代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。

- 顺序，就是先干啥，后干啥。例如，可以先加上某个数值，然后再减去某个数值。

TCP 协议里面会有两个端口，一个是浏览器监听的端口，一个是电商的服务器监听的端口。

![](https://static001.geekbang.org/resource/image/64/0c/64fcf0cc5baade70769da2160637d70c.jpg?wh=1435*877)

![](https://static001.geekbang.org/resource/image/59/54/5985d6d430e1b1d3f165bf0f916ed954.jpg?wh=1603*1198)

#### 第2讲 | 网络分层的真实含义是什么？

**网络为什么要分层？**

> 分层是一个逻辑概念，在做架构设计时，有句话叫没有什么问题是多加一层解决不了的。计算机网络的分层也是程序逻辑上的抽象。

![](https://static001.geekbang.org/resource/image/5c/76/5c00f6e610f533d17fb4ad7decacc776.jpg?wh=3226*3472)

### 第3讲 | ifconfig：最熟悉又陌生的命令行

> C类地址包含的最大主机数太少了。只有254个主机。 为什么是254个而不是255个？ 因为192.168.x.255不能作为主机，因为这是一个广播地址，只要给192.168.x.255地址发送网络包，处于192.168.x网段的所有机器都能够收到此网络包。

**无类型域间选路（CIDR）**

> CIDR 10.100.122.2/24 前24位是网络号，后8（32-24）位是主机号。 同一个网络号内，可以通过mac地址访问。 子网掩码是：将网络号位都置为1，主机号位用0补齐，即 255.255.255.0 广播地址是：网络号位不变，主机号用1补齐，即 10.100.122.255

网络号

> 将子网掩码和 IP 地址进行 AND 计算。前面三个 255，转成二进制都是 1。1 和任何数值取 AND，都是原来数值，因而前三个数不变，为 10.100.122。后面一个 0，转换成二进制是 0，0 和任何数值取 AND，都是 0，因而最后一个数变为 0，合起来就是 10.100.122.0。这就是网络号。

**小结**

IP 是地址，有定位功能；MAC 是身份证，无定位功能；

CIDR 可以用来判断是不是本地人；

IP 分公有的 IP 和私有的 IP；

### 第4讲 | DHCP与PXE：IP是怎么来的，又是怎么没的？

> 1. 正确配置IP?
> 
> CIDR、子网掩码、广播地址和网关地址。
> 
> 2. 在跨网段调用中，是如何获取目标IP的mac地址的？
> 
> 从源IP网关获取所在网关mac,
> 然后又替换为目标IP所在网段网关的mac,
> 最后是目标IP的mac地址
> 
> 3. 手动配置麻烦，怎么办？
> 
> DHCP！Dynamic Host Configuration Protocol！
> DHCP, 让你配置IP，如同自动房产中介。
> 
> 4. 如果新来的，房子是空的(没有操作系统)，怎么办？
> 
> PXE， Pre-boot Execution Environment.
> "装修队"PXE，帮你安装操作系统。

## 第二模块 底层网络知识详解：从二层到三层 (5讲)

### 第5讲 | 从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？

**第二层（数据链路层）**

你可能已经发现问题了。Hub 采取的是广播的模式，如果每一台电脑发出的包，宿舍的每个电脑都能收到，那就麻烦了。这就需要解决几个问题：

1. 这个包是发给谁的？谁应该接收？

2. 大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？

3. 如果发送的时候出现了错误，怎么办？

这几个问题，都是第二层，数据链路层，也即 MAC 层要解决的问题。MAC 的全称是 Medium Access Control，即媒体访问控制。控制什么呢？其实就是控制在往媒体上发数据的时候，谁先发、谁后发的问题。防止发生混乱。这解决的是第二个问题。这个问题中的规则，学名叫多路访问。

> 一个广播的网络里面接入了 N 台机器，我怎么知道每个 MAC 地址是谁呢？这就是 ARP 协议，也就是已知 IP 地址，求 MAC 地址的协议。

**小结**

好了，今天的内容差不多了，我们来总结一下，有三个重点需要你记住：

第一，MAC 层是用来解决多路访问的堵车问题的；

第二，ARP 是通过吼的方式来寻找目标 MAC 地址的，吼完之后记住一段时间，这个叫作缓存；

第三，交换机是有 MAC 地址学习能力的，学完了它就知道谁在哪儿了，不用广播了。

### 第6讲 | 交换机与VLAN：办公室太复杂，我要回学校
